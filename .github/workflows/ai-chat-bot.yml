# Dynamic AI Chat Bot Workflow
# @copyright   (c) Pierre-Henry Soria <https://ph7.me>
# @license     MIT <https://opensource.org/license/mit>

name: ðŸ¤– Dynamic AI Chat SVG

on:
  schedule:
    # Runs at 08:00 and 20:00 UTC
    - cron: '0 8 * * *'
    - cron: '0 20 * * *'
  workflow_dispatch:
    # Allows manual triggering
  push:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - '.github/workflows/ai-chat-bot.yml'

jobs:
  update-ai-chat-svg:
    name: ðŸš€ Update AI Chat SVG Message
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install setuptools wheel
          # No external dependencies needed for our script
      
      - name: ðŸŽ² Generate New Chat Message
        run: |
          python3 scripts/generate_chat.py
        env:
          TZ: 'UTC'
      
      - name: ðŸ” Check for Changes
        id: verify-changed-files
        run: |
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git diff --name-only
          fi
      
      - name: ðŸ“Š Show Generated Content
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          echo "ðŸ¤– New AI Chat Message Generated!"
          if [ -f "data/chat_data.json" ]; then
            echo "ðŸ“„ Chat Data:"
            cat data/chat_data.json | python -m json.tool
          fi
      
      - name: ðŸ’¾ Commit and Push Changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "AI Chat Bot ðŸ¤–"
          git add -A
          
          # Get the message from the generated data
          MESSAGE=$(python3 -c "
          import json
          try:
              with open('data/chat_data.json', 'r') as f:
                  data = json.load(f)
                  print(data['message'][:50] + '...' if len(data['message']) > 50 else data['message'])
          except:
              print('Updated AI chat SVG')
          ")
          
          git commit -m "ðŸ¤– Update AI chat SVG: $MESSAGE" \
                     -m "Generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" \
                     -m "Automated update from GitHub Actions" || exit 0
          
          git push
      
      - name: ðŸ“ˆ Workflow Summary
        if: always()
        run: |
          echo "## ðŸ¤– AI Chat SVG Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
            echo "âœ… **Status:** Successfully updated dynamic SVG with new message" >> $GITHUB_STEP_SUMMARY
            
            if [ -f "data/chat_data.json" ]; then
              MESSAGE=$(python3 -c "
              import json
              try:
                  with open('data/chat_data.json', 'r') as f:
                      data = json.load(f)
                      print(data['message'])
              except:
                  print('Unable to read message')
              ")
              echo "ðŸ’¬ **New Message:** $MESSAGE" >> $GITHUB_STEP_SUMMARY
              
              TIMESTAMP=$(python3 -c "
              import json
              try:
                  with open('data/chat_data.json', 'r') as f:
                      data = json.load(f)
                      print(data['last_updated'])
              except:
                  print('Unknown')
              ")
              echo "ðŸ•’ **Updated:** $TIMESTAMP" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ **Status:** No changes needed (same message as previous run)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”„ **Next Update:** In 6 hours (automatic)" >> $GITHUB_STEP_SUMMARY
          echo "âš¡ **Manual Trigger:** Available via workflow_dispatch" >> $GITHUB_STEP_SUMMARY

      - name: ðŸŽ¯ Performance Check
        if: always()
        run: |
          echo "âš¡ Workflow completed in $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ“Š Repository size: $(du -sh . | cut -f1)"
          echo "ðŸ—‚ï¸ Files modified: $(git diff --name-only HEAD~1 HEAD 2>/dev/null | wc -l || echo '0')"
